name: CI

on:
  pull_request:
    branches:
      - main
      - development

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  backend-unit:
    name: Backend - Unit tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install
        run: make backend-install

      - name: Test
        run: make backend-test-ci

      - name: Publish unit test report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Backend - Unit tests
          path: backend/test-results/junit.xml
          reporter: jest-junit

  backend-e2e:
    name: Backend - E2E tests (testcontainers)
    runs-on: ubuntu-latest
    needs: backend-unit
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install
        run: make backend-install

      - name: Docker info (diagn√≥stico)
        run: docker version && docker info

      - name: Pre-pull Redis image (reduz flake de rede)
        run: docker pull redis:7-alpine

      - name: Test (E2E)
        env:
          JEST_JUNIT_OUTPUT_NAME: junit-e2e.xml
        run: npm --prefix backend run test:e2e -- --reporters=default --reporters=jest-junit

      - name: Publish e2e test report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Backend - E2E tests
          path: backend/test-results/junit-e2e.xml
          reporter: jest-junit

  frontend-build:
    name: Frontend - Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: front-end/package-lock.json

      - name: Install
        run: make frontend-install

      - name: Build
        run: make frontend-build

  frontend-e2e:
    name: Frontend - E2E tests (Playwright)
    runs-on: ubuntu-latest
    needs: frontend-build
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: front-end/package-lock.json

      - name: Install dependencies
        run: make frontend-install

      - name: Install Playwright browsers
        working-directory: front-end
        run: npx playwright install --with-deps

      - name: Start dev server
        working-directory: front-end
        run: |
          npm run dev &
          npx wait-on http://localhost:5173 --timeout 60000

      - name: Run E2E tests (mocked)
        working-directory: front-end
        run: npm run test:e2e:ci -- pokedex-mocked.spec.ts

      - name: Publish E2E test report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Frontend - E2E tests
          path: front-end/test-results/junit.xml
          reporter: jest-junit

      - name: Upload Playwright HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: front-end/playwright-report/
          retention-days: 7


